name: Deploy to Render

on:
  push:
    branches: [ main ]

jobs:
  trigger-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Trigger Render deploy
        env:
          RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
        run: |
          if [ -z "$RENDER_SERVICE_ID" ] || [ -z "$RENDER_API_KEY" ]; then
            echo "Missing Render secrets. Set RENDER_SERVICE_ID and RENDER_API_KEY in repository secrets.";
            exit 1;
          fi

          echo "Requesting deploy for service $RENDER_SERVICE_ID"
          curl -s -X POST "https://api.render.com/v1/services/${RENDER_SERVICE_ID}/deploys" \
            -H "Authorization: Bearer ${RENDER_API_KEY}" \
            -H "Content-Type: application/json" \
            -d '{}' \
            -o /tmp/render-deploy-response.json

          cat /tmp/render-deploy-response.json

          # extract deploy id
          DEPLOY_ID=$(jq -r '.id' /tmp/render-deploy-response.json)
          if [ -z "$DEPLOY_ID" ] || [ "$DEPLOY_ID" = "null" ]; then
            echo "Failed to create deploy; response: "
            cat /tmp/render-deploy-response.json
            exit 1
          fi

          echo "Deploy created: $DEPLOY_ID. Polling status..."

          # Poll deploy status until succeeded or failed (timeout ~10 minutes)
          ATTEMPTS=0
          MAX_ATTEMPTS=60
          SLEEP=10
          while [ $ATTEMPTS -lt $MAX_ATTEMPTS ]; do
            ((ATTEMPTS++))
            sleep $SLEEP
            RESP=$(curl -s -H "Authorization: Bearer ${RENDER_API_KEY}" "https://api.render.com/v1/deploys/${DEPLOY_ID}")
            echo "[attempt $ATTEMPTS] $RESP"
            STATE=$(echo "$RESP" | jq -r '.state // .status // empty')
            if [ "$STATE" = "succeeded" ] || [ "$STATE" = "success" ]; then
              echo "Deploy succeeded"
              # When deploy succeeds, fetch service info to get the public domain
              curl -s -H "Authorization: Bearer ${RENDER_API_KEY}" "https://api.render.com/v1/services/${RENDER_SERVICE_ID}" -o /tmp/render-service.json
              DEFAULT_DOMAIN=$(jq -r '.defaultDomain' /tmp/render-service.json)
              echo "Service domain: $DEFAULT_DOMAIN"

              if [ -n "$DEFAULT_DOMAIN" ] && [ "$DEFAULT_DOMAIN" != "null" ]; then
                # perform a lightweight smoke test against /api/health
                echo "Running smoke-test against https://$DEFAULT_DOMAIN/api/health"
                SMOKE_ATTEMPTS=0
                SMOKE_MAX=12
                SMOKE_SLEEP=5
                while [ $SMOKE_ATTEMPTS -lt $SMOKE_MAX ]; do
                  ((SMOKE_ATTEMPTS++))
                  STATUS=$(curl -s -o /tmp/health.json -w "%{http_code}" "https://$DEFAULT_DOMAIN/api/health" || true)
                  echo "smoke attempt $SMOKE_ATTEMPTS => status $STATUS"
                  if [ "$STATUS" = "200" ]; then
                    cat /tmp/health.json
                    echo "Smoke-test passed"
                    exit 0
                  fi
                  sleep $SMOKE_SLEEP
                done
                echo "Smoke-test failed (no 200 response)"
                cat /tmp/health.json || true
                exit 1
              else
                echo "Could not determine service domain; skipping smoke test"
                exit 0
              fi
            fi
            if [ "$STATE" = "failed" ] || [ "$STATE" = "error" ] || [ "$STATE" = "canceled" ]; then
              echo "Deploy failed: $RESP"
              exit 1
            fi
          done

          echo "Timed out waiting for deploy to finish"
          exit 1
